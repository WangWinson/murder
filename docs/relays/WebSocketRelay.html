<!DOCTYPE html>

<html>
<head>
  <title>WebSocket Source</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="websocket-source">WebSocket Source</h1>
<p><a href="../index.html">lib/index.js</a> &gt; lib/relays/WebSocketRelay.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> WebSocket !== <span class="hljs-string">'function'</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">var</span> WebSocketServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'faye-websocket'</span> + <span class="hljs-string">''</span>),
        WebSocketClient = WebSocketServer.Client;
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'WebSocket client is not available.'</span>);
  }
}

<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../debug.js'</span>);

<span class="hljs-keyword">var</span> WebSocketRelay = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../core/Relay.js'</span>).adapt(<span class="hljs-string">'WebSocketRelay'</span>);

<span class="hljs-built_in">module</span>.exports = WebSocketRelay;

WebSocketRelay.prototype.websocket = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(params)</span> </span>{
  <span class="hljs-keyword">var</span> isHTML5WebSocket = <span class="hljs-keyword">typeof</span> WebSocket === <span class="hljs-string">'function'</span>,
      Client = isHTML5WebSocket ? WebSocket : WebSocketClient,
      connection = <span class="hljs-keyword">new</span> Client(params);
  connection.isHTML5WebSocket = isHTML5WebSocket;
  <span class="hljs-keyword">return</span> connection;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: handle reconnecting when the ws loses connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>WebSocketRelay.define(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(open)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> open.call(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> promise;
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.remote &amp;&amp; <span class="hljs-keyword">this</span>.options.url) {
        <span class="hljs-keyword">this</span>.remote = <span class="hljs-keyword">this</span>.websocket(<span class="hljs-keyword">this</span>.options.url, <span class="hljs-keyword">this</span>.options.protocols);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.remote.isHTML5WebSocket) {
          <span class="hljs-keyword">this</span>.remote.on = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event, listener)</span> </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>[<span class="hljs-string">'on'</span> + event]) {
              debug.warn(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Replacing existing listener for: '</span> + event).stack);
            }
            <span class="hljs-keyword">this</span>[<span class="hljs-string">'on'</span> + event] = listener;
          };
        }
        <span class="hljs-keyword">var</span> openPromise = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> </span>{
            <span class="hljs-keyword">this</span>.remote.on(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
              debug.log(source.type + <span class="hljs-string">'.remote..on-open'</span>);
              resolve(event);
            });
          }.bind(<span class="hljs-keyword">this</span>));
        }.bind(<span class="hljs-keyword">this</span>);
        promise = openPromise();
        <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>var ops = {i: {}, o: {}};</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.remote.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
          <span class="hljs-keyword">var</span> rawOperation = event.data;
          debug.log(<span class="hljs-keyword">this</span>.type + <span class="hljs-string">'.relay..on-message:'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'\n'</span>, rawOperation);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if (ops.i[rawOperation]) {
  debug.error(new Error(‘IN: REPEAT OPERATION’).stack);
  return;
}
ops.i[rawOperation] = true;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">this</span>.messageReceiver(rawOperation);
        }.bind(<span class="hljs-keyword">this</span>));
        <span class="hljs-keyword">this</span>.remote.emit = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, payload)</span> </span>{
          <span class="hljs-keyword">if</span> (!source.isOpen) { promise = openPromise(); }
          promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'message'</span> || name === <span class="hljs-string">'operation'</span>) {
              debug.warn(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'EMIT '</span> + name + <span class="hljs-string">' -- '</span> + payload).stack);
              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> payload !== <span class="hljs-string">'string'</span>) {
                payload = <span class="hljs-built_in">JSON</span>.stringify(payload);
              }
              debug.log(source.type + <span class="hljs-string">'.remote..send:'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'\n'</span>, payload);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>if (ops.o[payload]) {
  debug.error(new Error(‘OUT: REPEAT OPERATION’).stack);
  return;
}
ops.o[payload] = true;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">this</span>.send(payload);
            }
            <span class="hljs-keyword">else</span> {
              source.emit.apply(source, <span class="hljs-built_in">arguments</span>);
            }
          }.bind(<span class="hljs-keyword">this</span>));
        };
      }
      <span class="hljs-keyword">return</span> promise;
    });
  };
});

WebSocketRelay.define(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(close)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.remote) {
      debug.log(<span class="hljs-keyword">this</span>.type + <span class="hljs-string">'.remote..close'</span>);
      <span class="hljs-keyword">this</span>.remote.close();
    }
    <span class="hljs-keyword">return</span> close.call(<span class="hljs-keyword">this</span>);
  };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
