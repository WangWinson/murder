<!DOCTYPE html>

<html>
<head>
  <title>Redis Source</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="redis-source">Redis Source</h1>
<p><a href="../index.html">lib/index.js</a> &gt; lib/sources/RedisSource.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>);

<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../debug.js'</span>);

<span class="hljs-keyword">var</span> RedisSource = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../core/Source.js'</span>).adapt(<span class="hljs-string">'RedisSource'</span>);

<span class="hljs-built_in">module</span>.exports = RedisSource;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: finish implementation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
RedisSource.define(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(open)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isOpen) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emptyPromise(<span class="hljs-keyword">this</span>); }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>this.database = new NedbDatabase({filename: this.options.filename});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> open.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.load());
  };
});

RedisSource.define(<span class="hljs-string">'clear'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(clear)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> clear.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve, reject)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>this.database.remove({}, {multi: true}, function (err, numRemoved) {
  debug.warn(this.type + ‘: Removed ‘ + numRemoved + ‘ CRDT operations from local database.’);
  if (err) { reject(err); } else { resolve(this); }
}.bind(this));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }.bind(<span class="hljs-keyword">this</span>)));
  };
});

RedisSource.define(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(load)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dump)</span> </span>{
    <span class="hljs-keyword">return</span> load.call(<span class="hljs-keyword">this</span>, dump, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve, reject)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>this.database.loadDatabase(function (err) {
  if (err) { return reject(err); }
  Promise.all([
    new Promise(function (y, n) {
      this.database.ensureIndex({fieldName: ‘id’}, cb.bind(this, y, n));
    }.bind(this)),
    new Promise(function (y, n) {
      this.database.ensureIndex({fieldName: ‘type’}, cb.bind(this, y, n));
    }.bind(this)),
    new Promise(function (y, n) {
      this.database.ensureIndex({fieldName: ‘method’}, cb.bind(this, y, n));
    }.bind(this))
  ]).then(resolve, reject);
  function cb(resolve, reject, err) {/<em>jshint validthis:true</em>/
    if (err) { reject(err); } else { resolve(this); }
  }
}.bind(this));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }.bind(<span class="hljs-keyword">this</span>)));
  };
});

RedisSource.define(<span class="hljs-string">'append'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(append)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(operation)</span> </span>{
    <span class="hljs-keyword">return</span> append.call(<span class="hljs-keyword">this</span>, operation, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve, reject)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>this.database.insert(operation, function (err) {
  if (err) { debug.error(this.type, err); }
  if (err) { reject(err); } else { resolve(this); }
}.bind(this));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }.bind(<span class="hljs-keyword">this</span>)));
  };
});

RedisSource.define(<span class="hljs-string">'sync'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(sync)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(operation)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve, reject)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>var query = {id: operation.id};
this.database.find(query, function (err, log) {
  if (err) { return reject(err); }
  debug.info(‘find’, log);
  this.cache = this.cache || {};
  var override = Promise.all(log.map(this.broadcast.bind(this)));
  sync.call(this, operation, override).then(resolve, reject);
}.bind(this));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>return sync.call(this, operation, promise);//origin, );</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  };
});

RedisSource.define(<span class="hljs-string">'delete'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delete_)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(operation)</span> </span>{
    <span class="hljs-keyword">return</span> delete_.call(<span class="hljs-keyword">this</span>, operation, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve, reject)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>var query = {id: operation.id, $not: {method: ‘delete’}};
this.database.remove(query, {multi: true}, function (err, numRemoved) {
  debug.warn(this.type + ‘: Removed ‘ + numRemoved + ‘ CRDT operations from local database.’);
  if (err) { reject(err); } else { resolve(this); }
}.bind(this));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }.bind(<span class="hljs-keyword">this</span>)));
  };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
